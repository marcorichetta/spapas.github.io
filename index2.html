<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
    <title>/var/</title>
    <meta name="author" content="Serafeim Papastefanos">




    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="https://spapas.github.io/favicon.png" rel="icon">

    <link href="https://spapas.github.io/theme/css/main.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://spapas.github.io/theme/css/extra_style.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Fira+Sans:400,700&amp;subset=greek" rel="stylesheet">


    <script data-ad-client="ca-pub-7673322832689008" async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://spapas.github.io/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<ul class="main-navigation">
      <li >
        <a href="https://spapas.github.io/category/android.html">Android</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/css.html">Css</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/django.html">Django</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/elixir.html">Elixir</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/flask.html">Flask</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/git.html">Git</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/html.html">Html</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/javascript.html">Javascript</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/pelican.html">Pelican</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/postgresql.html">Postgresql</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/python.html">Python</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/spring.html">Spring</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/unix.html">Unix</a>
      </li>
      <li >
        <a href="https://spapas.github.io/category/wagtail.html">Wagtail</a>
      </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div class="blog-index">
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://spapas.github.io/2019/06/04/phoenix-form-select2-ajax/">Phoenix forms integration with select2 and ajax</a>
      </h1>
    <p class="meta">
<time datetime="2019-06-04T14:20:00+03:00" pubdate>Τρι 04 Ιούνιος 2019</time>    </p>
</header>

<div class="entry-content"><p>During the past months I&#8217;ve tried to implement a project using <a class="reference external" href="https://elixir-lang.org/">Elixir</a> and the <a class="reference external" href="https://phoenixframework.org/">Phoenix framework</a>. Old
visitors of my blog will probably remember that I mainly use Django for back-end development but I decided to
also give Phoenix a&nbsp;try.</p>
<p>My first impressions are positive but I don&#8217;t want to go into detail in this post; I&#8217;ll try to add a more
extensive post comparing Elixir / Phoenix with Python / Django&nbsp;someday.</p>
<p>The problem that this particular post will try to explain is how to properly integrate a jQuery <a class="reference external" href="https://select2.org/">select2</a>
dropdown ajax with autocomplete search to your <a class="reference external" href="https://hexdocs.pm/phoenix_html/Phoenix.HTML.Form.html">Phonix Forms</a>. This seems like a very common problem however I
couldn&#8217;t find a proper solution anywhere in the internet. It seems that most people using Phoenix prefer to
implement their autocompletes using <span class="caps">SPA</span> like functionality (react etc). Also I found <a class="reference external" href="https://github.com/nico-amsterdam/phoenix_form_awesomplete">this project</a> that
seems to be working, however it does not use select2 and I really didn&#8217;t like to mess with a different
<span class="caps">JS</span> library for reasons that should be too obvious to most&nbsp;people.</p>
<p>So here we&#8217;ll implement a simple solution for allowing your foreign key value to be autocompleted through ajax
using select2. The specific example is that you have a User that belongs to an Authority i.e user has a field
named <cite>authority_id</cite> which is a foreign key to authority. We&#8217;ll add a functionality to the user edit form to
select the authority using&nbsp;ajax-autocomplete.</p>
<p>Please notice that you can find a working version of this tutorial in my Phoenix Crud template project:
<a class="reference external" href="https://github.com/spapas/phxcrd">https://github.com/spapas/phxcrd</a>. This project contains various other functionality that I need but you should be
able to test the user - authority integration by following the instructions&nbsp;there.</p>
<div class="section" id="the-schemas">
<h2>The&nbsp;schemas</h2>
<p>For this tutorial, we&#8217;ll use two schemas: A <tt class="docutils literal">User</tt> and an <tt class="docutils literal">Authority</tt>. Each <tt class="docutils literal">User</tt> belongs to an <tt class="docutils literal">Authority</tt>
(thus will have a foreign key to <tt class="docutils literal">Authority</tt>; that&#8217;s what we want to set using the ajax select2). Here are
the ecto schemas for these&nbsp;entities:</p>
<div class="highlight"><pre><span></span><span class="kd">defmodule</span> <span class="nc">Phxcrd.Auth.Authority</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="nc">Ecto.Schema</span>

  <span class="kn">import</span> <span class="nc">Ecto.Changeset</span>
  <span class="kn">alias</span> <span class="nc">Phxcrd.Auth.User</span>

  <span class="n">schema</span> <span class="s2">&quot;authorities&quot;</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">has_many</span> <span class="ss">:users</span><span class="p">,</span> <span class="nc">User</span><span class="p">,</span> <span class="ss">on_replace</span><span class="p">:</span> <span class="ss">:nilify</span>
    <span class="n">timestamps</span><span class="p">()</span>
  <span class="k">end</span>

  <span class="na">@doc</span> <span class="no">false</span>
  <span class="kd">def</span> <span class="n">changeset</span><span class="p">(</span><span class="n">authority</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">authority</span>
    <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="p">[</span><span class="ss">:name</span><span class="p">])</span>
    <span class="o">|&gt;</span> <span class="n">validate_required</span><span class="p">([</span><span class="ss">:name</span><span class="p">],</span> <span class="ss">message</span><span class="p">:</span> <span class="s2">&quot;The field is required&quot;</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">unique_constraint</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">message</span><span class="p">:</span> <span class="s2">&quot;The name already exists!&quot;</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kn">use</span> <span class="nc">Accessible</span>
<span class="k">end</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="kd">defmodule</span> <span class="nc">Phxcrd.Auth.User</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="nc">Ecto.Schema</span>

  <span class="kn">import</span> <span class="nc">Ecto.Changeset</span>
  <span class="kn">alias</span> <span class="nc">Phxcrd.Auth.Authority</span>

  <span class="n">schema</span> <span class="s2">&quot;users&quot;</span> <span class="k">do</span>
    <span class="n">field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">field</span> <span class="ss">:username</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">field</span> <span class="ss">:password_hash</span><span class="p">,</span> <span class="ss">:string</span>
    <span class="n">field</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:string</span><span class="p">,</span> <span class="ss">virtual</span><span class="p">:</span> <span class="no">true</span>

    <span class="n">belongs_to</span> <span class="ss">:authority</span><span class="p">,</span> <span class="nc">Authority</span>

    <span class="n">timestamps</span><span class="p">()</span>
  <span class="k">end</span>

  <span class="na">@doc</span> <span class="no">false</span>
  <span class="kd">def</span> <span class="n">changeset</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">user</span>
    <span class="o">|&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="p">[</span><span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:authority_id</span><span class="p">])</span>
    <span class="o">|&gt;</span> <span class="n">validate_required</span><span class="p">([</span><span class="ss">:username</span><span class="p">,</span> <span class="ss">:email</span> <span class="p">])</span>
  <span class="k">end</span>

  <span class="kn">use</span> <span class="nc">Accessible</span>
<span class="k">end</span>
</pre></div>
<p>Notice that both these entities are contained in the <tt class="docutils literal">Auth</tt> context and were created using
<tt class="docutils literal">mix phx.gen.html</tt>; I won&#8217;t include the migrations&nbsp;here.</p>
</div>
<div class="section" id="the-search-api">
<h2>The search <span class="caps">API</span></h2>
<p>Let&#8217;s now take a look at the search api for <tt class="docutils literal">Authority</tt>. I&#8217;ve added an <tt class="docutils literal">ApiController</tt>  which contains
the following&nbsp;function:</p>
<div class="highlight"><pre><span></span><span class="kd">def</span> <span class="n">search_authorities</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;q&quot;</span><span class="p">]</span>

    <span class="n">authorities</span> <span class="o">=</span>
      <span class="n">from</span><span class="p">(</span><span class="n">a</span> <span class="ow">in</span> <span class="nc">Authority</span><span class="p">,</span>
        <span class="ss">where</span><span class="p">:</span> <span class="n">ilike</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="o">^</span><span class="s2">&quot;%</span><span class="si">#{</span><span class="n">q</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
      <span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">limit</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="nc">Repo</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;authorities.json&quot;</span><span class="p">,</span> <span class="ss">authorities</span><span class="p">:</span> <span class="n">authorities</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
<p>Notice that this retrieves a <cite>q</cite> parameter and makes an <cite>ilike</cite> query to <cite>Authority.name</cite>. It then
passes the results to the view for rendering. Here&#8217;s the corresponding function for <cite>ApiView</cite>:</p>
<div class="highlight"><pre><span></span><span class="kd">def</span> <span class="n">render</span><span class="p">(</span><span class="s2">&quot;authorities.json&quot;</span><span class="p">,</span> <span class="p">%{</span><span class="ss">authorities</span><span class="p">:</span> <span class="n">authorities</span><span class="p">})</span> <span class="k">do</span>
    <span class="p">%{</span><span class="ss">results</span><span class="p">:</span> <span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">authorities</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">authority_json</span><span class="o">/</span><span class="mi">1</span><span class="p">)}</span>
  <span class="k">end</span>

  <span class="kd">def</span> <span class="n">authority_json</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">%{</span>
      <span class="ss">id</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
      <span class="ss">text</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span>
    <span class="p">}</span>
<span class="k">end</span>
</pre></div>
<p>Notice that select2 wants its results in a <span class="caps">JSON</span> struct with the following form <tt class="docutils literal">{results: [{id: 1, name: &quot;Authority <span class="pre">1&quot;}]}</span></tt>.</p>
<p>To add this controller action to my routes I&#8217;ve added this to <tt class="docutils literal">router.ex</tt>:</p>
<div class="highlight"><pre><span></span><span class="n">scope</span> <span class="s2">&quot;/api&quot;</span><span class="p">,</span> <span class="nc">PhxcrdWeb</span> <span class="k">do</span>
    <span class="n">pipe_through</span> <span class="ss">:api</span>

    <span class="n">get</span> <span class="s2">&quot;/search_authorities&quot;</span><span class="p">,</span> <span class="nc">ApiController</span><span class="p">,</span> <span class="ss">:search_authorities</span>
<span class="k">end</span>
</pre></div>
<p>Thus if you visit <tt class="docutils literal"><span class="pre">http://127.0.0.1/search_authorities?q=A</span></tt> you should retrieve authorities containing <tt class="docutils literal">A</tt> in their&nbsp;name.</p>
</div>
<div class="section" id="the-controller">
<h2>The&nbsp;controller</h2>
<p>Concenring the <tt class="docutils literal">UserController</tt> I&#8217;ve added the following methods to it for creating and updating&nbsp;users:</p>
<div class="highlight"><pre><span></span><span class="kd">def</span> <span class="n">new</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_params</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">changeset</span> <span class="o">=</span> <span class="nc">Auth</span><span class="o">.</span><span class="n">change_user</span><span class="p">(%</span><span class="nc">User</span><span class="p">{})</span>
  <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;new.html&quot;</span><span class="p">,</span> <span class="ss">changeset</span><span class="p">:</span> <span class="n">changeset</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">def</span> <span class="n">create</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="s2">&quot;user&quot;</span> <span class="o">=&gt;</span> <span class="n">user_params</span><span class="p">})</span> <span class="k">do</span>
  <span class="k">case</span> <span class="nc">Auth</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="n">put_flash</span><span class="p">(</span><span class="ss">:info</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> created!&quot;</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">redirect</span><span class="p">(</span><span class="ss">to</span><span class="p">:</span> <span class="nc">Routes</span><span class="o">.</span><span class="n">user_path</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:show</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>

    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">changeset</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;new.html&quot;</span><span class="p">,</span> <span class="ss">changeset</span><span class="p">:</span> <span class="n">changeset</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="kd">def</span> <span class="n">edit</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="n">id</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="nc">Auth</span><span class="o">.</span><span class="n">get_user!</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
  <span class="n">changeset</span> <span class="o">=</span> <span class="nc">Auth</span><span class="o">.</span><span class="n">change_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;edit.html&quot;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">changeset</span><span class="p">:</span> <span class="n">changeset</span><span class="p">)</span>
<span class="k">end</span>

<span class="kd">def</span> <span class="n">update</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="p">%{</span><span class="s2">&quot;id&quot;</span> <span class="o">=&gt;</span> <span class="n">id</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span> <span class="o">=&gt;</span> <span class="n">user_params</span><span class="p">})</span> <span class="k">do</span>
  <span class="n">user</span> <span class="o">=</span> <span class="nc">Auth</span><span class="o">.</span><span class="n">get_user!</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>

  <span class="n">user_params</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">merge</span><span class="p">(%{</span><span class="s2">&quot;authority_id&quot;</span> <span class="o">=&gt;</span> <span class="no">nil</span><span class="p">},</span> <span class="n">user_params</span><span class="p">)</span>

  <span class="k">case</span> <span class="nc">Auth</span><span class="o">.</span><span class="n">update_user</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">user_params</span><span class="p">)</span> <span class="k">do</span>
    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">user</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">conn</span>
      <span class="o">|&gt;</span> <span class="n">put_flash</span><span class="p">(</span><span class="ss">:info</span><span class="p">,</span> <span class="s2">&quot;User updated successfully.&quot;</span><span class="p">)</span>
      <span class="o">|&gt;</span> <span class="n">redirect</span><span class="p">(</span><span class="ss">to</span><span class="p">:</span> <span class="nc">Routes</span><span class="o">.</span><span class="n">user_path</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="ss">:show</span><span class="p">,</span> <span class="n">user</span><span class="p">))</span>

    <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="p">%</span><span class="nc">Ecto.Changeset</span><span class="p">{}</span> <span class="o">=</span> <span class="n">changeset</span><span class="p">}</span> <span class="o">-&gt;</span>
      <span class="n">render</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;edit.html&quot;</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="ss">changeset</span><span class="p">:</span> <span class="n">changeset</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>Most of these are more or less the default things that <tt class="docutils literal">mix phx.gen.html</tt> creates.
One thing that may seem a strange here is the <tt class="docutils literal">user_params = <span class="pre">Map.merge(%{&quot;authority_id&quot;</span> =&gt; nil}, user_params)</tt>
line of <tt class="docutils literal">update</tt>. What happens here is that I want to be able to clear the authority of a user (I&#8217;ll
explain how in the next sections). If I do
that then the <tt class="docutils literal">user_params</tt> that is passed to <tt class="docutils literal">update</tt> will <em>not</em> contain an <tt class="docutils literal">authority_id</tt> key thus
the <tt class="docutils literal">authority_id</tt> won&#8217;t be changed at all (so even though I cleared it, it will keep its previous value after
I save it). To fix that I set a default value of <tt class="docutils literal">nil</tt> to <tt class="docutils literal">authority_id</tt>; if the user has actually selected
an authority from the form this will be overriden when merging the two maps. So the resulting <tt class="docutils literal">user_params</tt> will
<em>always</em> contain an <tt class="docutils literal">authority_id</tt> key, either set to nil or to the selected&nbsp;authority.</p>
<p>Beyond that I wont&#8217; go into detail explaining the above functions,  but if something seems strange feel free to ask. I
also won&#8217;t explain the <tt class="docutils literal">Auth.*</tt> functions; all these are created by phoenix in the context&nbsp;module.</p>
</div>
<div class="section" id="the-view">
<h2>The&nbsp;view</h2>
<p>The <tt class="docutils literal">UserView</tt> module contains a simple but very important&nbsp;function:</p>
<div class="highlight"><pre><span></span><span class="kd">def</span> <span class="n">get_select_value</span><span class="p">(</span><span class="n">changeset</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">case</span> <span class="n">changeset</span><span class="o">.</span><span class="n">changes</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="k">do</span>
    <span class="no">nil</span> <span class="o">-&gt;</span> <span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">changeset</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">-&gt;</span> <span class="n">z</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>This functions gets two parameters: The changeset and the name of the attribute (<tt class="docutils literal">:authority_id</tt> in our case). What
it does is to first check if this attribute is contained in the changeset.changes; if yes it will return that value. If
it isn&#8217;t contained in the changeset.changes then it will return the value of changeset.data for that&nbsp;attribute.</p>
<p>This is a little complex but let&#8217;s try to understand its logic: When you start editing a <tt class="docutils literal">User</tt> you want to display
the current authority of that instance. However, when you submit an edited user and retrieve an errored form (for example
because you forgot to fill the username) you want to display the authority that <em>was submitted</em> in the form. So the
<tt class="docutils literal">changeset.changes</tt> contains the changes that were submitted just before while the <tt class="docutils literal">changeset.data</tt> contain the
initial value of the&nbsp;struct.</p>
<p><strong>Update 02/07/2019:</strong> Please notice that instead of using the
<tt class="docutils literal">get_select_value</tt> I presented before you can use the
<tt class="docutils literal">Ecto.Changeset.get_field</tt> function that does exactly this! So
<tt class="docutils literal">get_select_value</tt> could be defined like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kd">def</span> <span class="n">get_select_value</span><span class="p">(</span><span class="n">changeset</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">changeset</span> <span class="o">|&gt;</span> <span class="nc">Ecto.Changeset</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="section" id="the-form-template">
<h2>The form&nbsp;template</h2>
<p>Both the <tt class="docutils literal">:new</tt> and <tt class="docutils literal">:edit</tt> actions include a common form.html.eex&nbsp;template:</p>
<div class="highlight"><pre><span></span><span class="err">&lt;</span>%= form_for @changeset, @action, fn f -&gt; %&gt;
  <span class="err">&lt;</span>%= if @changeset.action do %&gt;
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert alert-danger&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span><span class="err">&lt;</span>%= gettext(&quot;Problems while saving&quot;) %&gt;<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="err">&lt;</span>% end %&gt;
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;row&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">&gt;</span>
      <span class="err">&lt;</span>%= label f, :username %&gt;
      <span class="err">&lt;</span>%= text_input f, :username %&gt;
      <span class="err">&lt;</span>%= error_tag f, :username %&gt;
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">&gt;</span>
      <span class="err">&lt;</span>%= label f, :email %&gt;
      <span class="err">&lt;</span>%= text_input f, :email %&gt;
      <span class="err">&lt;</span>%= error_tag f, :email %&gt;
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;row&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column&#39;</span><span class="p">&gt;</span>
      <span class="err">&lt;</span>%= label f, :authority %&gt;
      <span class="err">&lt;</span>%= select(f,
        :authority_id, [
          (with sv when not is_nil(sv) <span class="p">&lt;</span><span class="nt">-</span> <span class="na">get_select_value</span><span class="err">(@</span><span class="na">changeset</span><span class="err">,</span> <span class="na">:authority_id</span><span class="err">),</span>
                                     <span class="na">a</span> <span class="err">&lt;</span><span class="na">-</span> <span class="na">Phxcrd</span><span class="err">.</span><span class="na">Auth</span><span class="err">.</span><span class="na">get_authority</span><span class="err">!(</span><span class="na">sv</span><span class="err">),</span> <span class="na">do:</span> <span class="err">{</span><span class="na">a</span><span class="err">.</span><span class="na">name</span><span class="err">,</span> <span class="na">a</span><span class="err">.</span><span class="na">id</span><span class="err">})</span>
        <span class="err">],</span>
        <span class="na">style:</span> <span class="err">&quot;</span><span class="na">width:</span> <span class="na">100</span><span class="err">%&quot;)</span>
        <span class="err">%</span><span class="p">&gt;</span>
      <span class="err">&lt;</span>%= error_tag f, :authority_id %&gt;
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="err">&lt;</span>%= submit gettext(&quot;Save&quot;) %&gt;
  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="err">&lt;</span>% end %&gt;
</pre></div>
<p>This is a custom Phoenix form but it has the following addition which is more or less the meat of this article
(along with the <tt class="docutils literal">get_select_value</tt> function I explained&nbsp;before):</p>
<div class="highlight"><pre><span></span><span class="n">select</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="ss">:authority_id</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">with</span> <span class="n">sv</span> <span class="ow">when</span> <span class="ow">not</span> <span class="n">is_nil</span><span class="p">(</span><span class="n">sv</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">get_select_value</span><span class="p">(</span><span class="na">@changeset</span><span class="p">,</span> <span class="ss">:authority_id</span><span class="p">),</span>
                                   <span class="n">a</span> <span class="o">&lt;-</span> <span class="nc">Phxcrd.Auth</span><span class="o">.</span><span class="n">get_authority!</span><span class="p">(</span><span class="n">sv</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="p">{</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
      <span class="p">],</span>
      <span class="ss">style</span><span class="p">:</span> <span class="s2">&quot;width: 100%&quot;</span><span class="p">)</span>
</pre></div>
<p>So this will create an html select element which will contain a single value (the array in the third
parameter of <tt class="docutils literal">select</tt>): The authority of that object or the authority that the user had submitted
in the form. For this it uses <tt class="docutils literal">get_select_value</tt> to retrieve the :authority_id and if it&#8217;s not nil
it passes it to <tt class="docutils literal">get_authority!</tt> to retrieve the actual authority and return a tuple with its name and&nbsp;id.</p>
<p>By default when you create a <tt class="docutils literal">select</tt> element you&#8217;ll pass an array of all options in the third
parameter, for&nbsp;example:</p>
<div class="highlight"><pre><span></span><span class="n">select</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="ss">:authority_id</span><span class="p">,</span> <span class="nc">Phxcrd.Auth</span><span class="o">.</span><span class="n">list_authorities</span> <span class="o">|&gt;</span> <span class="nc">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">{</span><span class="ni">&amp;1</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="ni">&amp;1</span><span class="o">.</span><span class="n">id</span><span class="p">}))</span>
</pre></div>
<p>Of course this beats the purpose of using ajax since all options will be&nbsp;rendered.</p>
<p>The final step is to add the required custom javascript to convert that select to&nbsp;select2-with-ajax:</p>
<div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#user_authority_id&#39;</span><span class="p">).</span><span class="nx">select2</span><span class="p">({</span>
      <span class="nx">allowClear</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">placeholder</span><span class="o">:</span> <span class="s1">&#39;Select authority&#39;</span><span class="p">,</span>
      <span class="nx">ajax</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;&lt;%= Routes.api_path(@conn, :search_authorities) %&gt;&#39;</span><span class="p">,</span>
        <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
        <span class="nx">delay</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
        <span class="nx">minimumInputLength</span><span class="o">:</span> <span class="mi">2</span>
      <span class="p">}</span>
    <span class="p">});</span>
<span class="p">})</span>
</pre></div>
<p>The <span class="caps">JS</span> very rather simple; the <tt class="docutils literal">allowClear</tt> option will display an <tt class="docutils literal">x</tt> so that you can clear the
selected authority while the ajax url will be that of the <tt class="docutils literal">:search_authorities</tt>.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Although this article may seem a little long, as I&#8217;ve already mentioned the most important thing
to keep is how to properly set the value that should be displayed in your <tt class="docutils literal">select2</tt> widget. Beyond
that everything is a walk in the park by following the&nbsp;docs.</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://spapas.github.io/2019/04/05/android-custom-filter-adapter/">How to create a custom filtered adapter in Android</a>
      </h1>
    <p class="meta">
<time datetime="2019-04-05T12:20:00+03:00" pubdate>Παρ 05 Απρίλιος 2019</time>    </p>
</header>

<div class="entry-content"><div class="section" id="introduction">
<h2>Introduction</h2>
<p>Android offers a nice component named <a class="reference external" href="https://developer.android.com/reference/android/widget/AutoCompleteTextView">AutoCompleteTextView</a> that can be used to auto-fill a text box from a list of values.
In its simplest form, you just create an array adapter passing it a list of objects (that have a proper <tt class="docutils literal">toString()</tt> method).
Then you type some characters to the textbox and by default it will filter the results searching
in the <em>beginning of the backing object&#8217;s toString() result</em>.</p>
<p>However there are times that you don&#8217;t want to look at the beginning of the string (because you want to look at the middle of the string) or
you don&#8217;t want to just to search in toString() method of the object or you want to do some more fancy things in object output. For this
you must override the <tt class="docutils literal">ArrayAdapter</tt> and add a custom <tt class="docutils literal">Filter</tt>.</p>
<p>Unfurtunately this isn&#8217;t as straightforward as I&#8217;d like and I couldn&#8217;t find a quick and easy tutorial on how it can be&nbsp;done.</p>
<p>So here goes nothing: In the following I&#8217;ll show you a very simple android application that will have <em>the minimum viable</em> custom filtered
adapter implementation. You can find the whole project in github: <a class="reference external" href="https://github.com/spapas/CustomFilteredAdapeter">https://github.com/spapas/CustomFilteredAdapeter</a> but I am going to discuss
everything here&nbsp;also.</p>
</div>
<div class="section" id="the-application">
<h2>The&nbsp;application</h2>
<p>Just create a new project with an empty activity from Android Studio. Use kotlin as the&nbsp;language.</p>
</div>
<div class="section" id="the-layout">
<h2>The&nbsp;layout</h2>
<p>I&#8217;ll keep it as simple as&nbsp;possible:</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span class="nt">&lt;LinearLayout</span>
        <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
        <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
        <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span> <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
        <span class="na">tools:context=</span><span class="s">&quot;.MainActivity&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;TextView</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span> <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:text=</span><span class="s">&quot;Hello World!&quot;</span>
            <span class="na">android:textSize=</span><span class="s">&quot;32sp&quot;</span>
            <span class="na">android:textAlignment=</span><span class="s">&quot;center&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;AutoCompleteTextView</span>
            <span class="na">android:layout_marginTop=</span><span class="s">&quot;32dip&quot;</span>
            <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span> <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
            <span class="na">android:id=</span><span class="s">&quot;@+id/autoCompleteTextView&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/LinearLayout&gt;</span>
</pre></div>
<p>You should just care about the <tt class="docutils literal">AutoCompleteTextView</tt> with an id of <tt class="docutils literal">autoCompleteTextView</tt>.</p>
</div>
<div class="section" id="the-backing-data-object">
<h2>The backing data&nbsp;object</h2>
<p>I&#8217;ll use a simple PoiDao Kotlin data class for&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">data</span> <span class="k">class</span> <span class="nc">PoiDao</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">city</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">category_name</span><span class="p">:</span> <span class="n">String</span>
<span class="p">)</span>
</pre></div>
<p>I&#8217;d like to be able to search to both name, city and category_name of each object. To create a list of the pois to be used to the adapter I can do something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">val</span> <span class="py">poisArray</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span>
    <span class="n">PoiDao</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="s">&quot;Taco Bell&quot;</span><span class="p">,</span> <span class="s">&quot;Athens&quot;</span><span class="p">,</span> <span class="s">&quot;Restaurant&quot;</span><span class="p">),</span>
    <span class="n">PoiDao</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="s">&quot;McDonalds&quot;</span><span class="p">,</span> <span class="s">&quot;Athens&quot;</span><span class="p">,</span><span class="s">&quot;Restaurant&quot;</span><span class="p">),</span>
    <span class="n">PoiDao</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="s">&quot;KFC&quot;</span><span class="p">,</span> <span class="s">&quot;Piraeus&quot;</span><span class="p">,</span> <span class="s">&quot;Restaurant&quot;</span><span class="p">),</span>
    <span class="n">PoiDao</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="s">&quot;Shell&quot;</span><span class="p">,</span> <span class="s">&quot;Lamia&quot;</span><span class="p">,</span><span class="s">&quot;Gas Station&quot;</span><span class="p">),</span>
    <span class="n">PoiDao</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="s">&quot;BP&quot;</span><span class="p">,</span> <span class="s">&quot;Thessaloniki&quot;</span><span class="p">,</span> <span class="s">&quot;Gas Station&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="the-custom-adapter">
<h2>The custom&nbsp;adapter</h2>
<p>This will be an <tt class="docutils literal">ArrayAdapter&lt;PoiDao&gt;</tt> implementing also the <tt class="docutils literal">Filterable</tt> interface:</p>
<div class="highlight"><pre><span></span><span class="k">inner</span> <span class="k">class</span> <span class="nc">PoiAdapter</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">@LayoutRes</span> <span class="k">private</span> <span class="k">val</span> <span class="py">layoutResource</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="k">private</span> <span class="k">val</span> <span class="py">allPois</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">PoiDao</span><span class="p">&gt;):</span>
    <span class="n">ArrayAdapter</span><span class="p">&lt;</span><span class="n">PoiDao</span><span class="p">&gt;(</span><span class="n">context</span><span class="p">,</span> <span class="n">layoutResource</span><span class="p">,</span> <span class="n">allPois</span><span class="p">),</span>
    <span class="n">Filterable</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">var</span> <span class="py">mPois</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">PoiDao</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">allPois</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getCount</span><span class="p">():</span> <span class="n">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">mPois</span><span class="p">.</span><span class="n">size</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getItem</span><span class="p">(</span><span class="n">p0</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">PoiDao</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">mPois</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getItemId</span><span class="p">(</span><span class="n">p0</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Long</span> <span class="p">{</span>
        <span class="c1">// Or just return p0</span>
        <span class="k">return</span> <span class="n">mPois</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">p0</span><span class="p">).</span><span class="n">id</span><span class="p">.</span><span class="n">toLong</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getView</span><span class="p">(</span><span class="n">position</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">convertView</span><span class="p">:</span> <span class="n">View</span><span class="p">?,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">ViewGroup</span><span class="p">?):</span> <span class="n">View</span> <span class="p">{</span>
        <span class="k">val</span> <span class="py">view</span><span class="p">:</span> <span class="n">TextView</span> <span class="p">=</span> <span class="n">convertView</span> <span class="k">as</span> <span class="n">TextView</span><span class="p">?</span> <span class="o">?:</span> <span class="n">LayoutInflater</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">inflate</span><span class="p">(</span><span class="n">layoutResource</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span> <span class="k">as</span> <span class="n">TextView</span>
        <span class="n">view</span><span class="p">.</span><span class="n">text</span> <span class="p">=</span> <span class="s">&quot;${mPois[position].name} ${mPois[position].city} (${mPois[position].category_name})&quot;</span>
        <span class="k">return</span> <span class="n">view</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getFilter</span><span class="p">():</span> <span class="n">Filter</span> <span class="p">{</span>
        <span class="c1">// See next section</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>You&#8217;ll see that we add an instance variable named <tt class="docutils literal">mPois</tt> that gets initialized in the start with <tt class="docutils literal">allPois</tt> (which is the initial list of all pois that is passed to the adapter). The mPois
will contain the <em>filtered</em> results. Then,
for <tt class="docutils literal">getCount</tt> and <tt class="docutils literal">getItem</tt> we return the corresponding valeus from <tt class="docutils literal">mPois</tt>; the <tt class="docutils literal">getItemId</tt> is used when you have an sqlite backed adapter but I&#8217;m including it here for&nbsp;completeness.</p>
<p>The <tt class="docutils literal">getView</tt> will create the specific line for each item in the dropdown. As you&#8217;ll see the layout that is passed must have a <tt class="docutils literal">text</tt> child which is set based on some of the attributes of
the corresponding poi for each position. Notice that we can use whatever view layout we want for our dropdown result line (this is the <tt class="docutils literal">layoutResource</tt> parameter) but we need to configure
it (i.e bind it with the values of the backing object) here&nbsp;properly.</p>
<p>Finally we create a custom instance of the <tt class="docutils literal">Filter</tt>, explained in the next&nbsp;section.</p>
</div>
<div class="section" id="the-custom-filter">
<h2>The custom&nbsp;filter</h2>
<p>The <tt class="docutils literal">getFilter</tt> creates an object instance of a Filter and returns&nbsp;it:</p>
<div class="highlight"><pre><span></span><span class="k">override</span> <span class="k">fun</span> <span class="nf">getFilter</span><span class="p">():</span> <span class="n">Filter</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">object</span> <span class="p">:</span> <span class="nc">Filter</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">publishResults</span><span class="p">(</span><span class="n">charSequence</span><span class="p">:</span> <span class="n">CharSequence</span><span class="p">?,</span> <span class="n">filterResults</span><span class="p">:</span> <span class="n">Filter</span><span class="p">.</span><span class="n">FilterResults</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mPois</span> <span class="p">=</span> <span class="n">filterResults</span><span class="p">.</span><span class="n">values</span> <span class="k">as</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">PoiDao</span><span class="p">&gt;</span>
            <span class="n">notifyDataSetChanged</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">override</span> <span class="k">fun</span> <span class="nf">performFiltering</span><span class="p">(</span><span class="n">charSequence</span><span class="p">:</span> <span class="n">CharSequence</span><span class="p">?):</span> <span class="n">Filter</span><span class="p">.</span><span class="n">FilterResults</span> <span class="p">{</span>
            <span class="k">val</span> <span class="py">queryString</span> <span class="p">=</span> <span class="n">charSequence</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span><span class="o">?.</span><span class="n">toLowerCase</span><span class="p">()</span>

            <span class="k">val</span> <span class="py">filterResults</span> <span class="p">=</span> <span class="n">Filter</span><span class="p">.</span><span class="n">FilterResults</span><span class="p">()</span>
            <span class="n">filterResults</span><span class="p">.</span><span class="n">values</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">queryString</span><span class="p">==</span><span class="k">null</span> <span class="p">||</span> <span class="n">queryString</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span>
                <span class="n">allPois</span>
            <span class="k">else</span>
                <span class="n">allPois</span><span class="p">.</span><span class="n">filter</span> <span class="p">{</span>
                    <span class="n">it</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="n">queryString</span><span class="p">)</span> <span class="p">||</span>
                    <span class="n">it</span><span class="p">.</span><span class="n">city</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="n">queryString</span><span class="p">)</span> <span class="p">||</span>
                    <span class="n">it</span><span class="p">.</span><span class="n">category_name</span><span class="p">.</span><span class="n">toLowerCase</span><span class="p">().</span><span class="n">contains</span><span class="p">(</span><span class="n">queryString</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="k">return</span> <span class="n">filterResults</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>This object instance overrides two methods of <tt class="docutils literal">Filter</tt>: <tt class="docutils literal">performFiltering</tt> and <tt class="docutils literal">publishResults</tt>. The <tt class="docutils literal">performFiltering</tt> is where the actual filtering is done;
it should return a <tt class="docutils literal">FilterResults</tt> object containing a <tt class="docutils literal">values</tt> attribute with the filtered values. In this method
we retrieve the <tt class="docutils literal">charSequence</tt> parameter and converit it to lowercase. Then, if this parameter is not empty we filter the corresponding elements of <tt class="docutils literal">allPois</tt>
(i.e name, city and category_name in our case) using contains. If the query parameter is empty then we just return all pois. Warning java developers; here the if
is used as an expression (i.e its result will be assigned to <tt class="docutils literal">filterResults.values</tt>).</p>
<p>After the performFiltering has finished, the <tt class="docutils literal">publishResults</tt> method is called. This method retrieves the filtered results in its <tt class="docutils literal">filterResults</tt> parameter. Thus it sets
<tt class="docutils literal">mPois</tt> of the custom adapter is set to the result of the filter operation and calls <tt class="docutils literal">notifyDataSetChanged</tt> to display the&nbsp;results.</p>
</div>
<div class="section" id="using-the-custom-adapter">
<h2>Using the custom&nbsp;adapter</h2>
<p>To use the custom adapter you can do something like this in your activity&#8217;s&nbsp;onCreate:</p>
<div class="highlight"><pre><span></span><span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

    <span class="k">val</span> <span class="py">poisArray</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span>
        <span class="c1">// See previous sections</span>
    <span class="p">)</span>
    <span class="k">val</span> <span class="py">adapter</span> <span class="p">=</span> <span class="n">PoiAdapter</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">android</span><span class="p">.</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">simple_list_item_1</span><span class="p">,</span> <span class="n">poisArray</span><span class="p">)</span>
    <span class="n">autoCompleteTextView</span><span class="p">.</span><span class="n">setAdapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span>
    <span class="n">autoCompleteTextView</span><span class="p">.</span><span class="n">threshold</span> <span class="p">=</span> <span class="m">3</span>

    <span class="n">autoCompleteTextView</span><span class="p">.</span><span class="n">setOnItemClickListener</span><span class="p">()</span> <span class="p">{</span> <span class="n">parent</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">id</span> <span class="p">-&gt;</span>
        <span class="k">val</span> <span class="py">selectedPoi</span> <span class="p">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">adapter</span><span class="p">.</span><span class="n">getItem</span><span class="p">(</span><span class="n">position</span><span class="p">)</span> <span class="k">as</span> <span class="n">PoiDao</span><span class="p">?</span>
        <span class="n">autoCompleteTextView</span><span class="p">.</span><span class="n">setText</span><span class="p">(</span><span class="n">selectedPoi</span><span class="o">?.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>We create the PoiAdapter passing it the poisArray and <tt class="docutils literal">android.R.layout.simple_list_item_1</tt> as the layout. That layout just contains a textview named text. As we&#8217;ve already
discussed you can pass something more complex here. The <tt class="docutils literal">thresold</tt> defined the number of characters that the user that needs to enter to do the filtering (default is&nbsp;2).</p>
<p>Please notice that when the user clicks (selects) on an item of the dropdown we set the contents of the textview (or else it will just use the object&#8217;s toString() method to set&nbsp;it).</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://spapas.github.io/2019/02/25/django-fix-async-db/">Fixing your Django async job - database integration</a>
      </h1>
    <p class="meta">
<time datetime="2019-02-25T15:20:00+02:00" pubdate>Δευ 25 Φεβρουάριος 2019</time>    </p>
</header>

<div class="entry-content"><p>I&#8217;ve already written
<a class="reference external" href="https://spapas.github.io/2015/01/27/async-tasks-with-django-rq/">two</a>
<a class="reference external" href="https://spapas.github.io/2015/09/01/django-rq-redux/">articles</a>
about django-rq and implementing asynchronous tasks in Django. However I&#8217;ve found out
that there&#8217;s a very important thing missing from them: How to properly integrate
your asynchronous tasks with your Django database. This is very important because
if it is not done right you will start experiencing strange errors about missing
database objects or duplicate keys. The most troublesome thing about these errors is
that they are not consistent. Your app may work fine but for some reason you&#8217;ll see some
of your asynchronous tasks fail with these errors. When you re-queue the async jobs everything will
be&nbsp;ok.</p>
<p>Of course this behavior (code that runs <em>sometimes</em>) smells of a race condition but its not easy to debug
it if you don&#8217;t know the full&nbsp;story.</p>
<p>In the following I will describe the cause of this error and how you can fix it. As a companion
to this article I&#8217;ve implemented a small project that can be used to test the error and the
fix: <a class="reference external" href="https://github.com/spapas/async-job-db-fix">https://github.com/spapas/async-job-db-fix</a>.</p>
<p>Notice that although this article is written for django-rq it should also help people that have
the same problems with other async job systems (like celery or&nbsp;django-q).</p>
<div class="section" id="description-of-the-project">
<h2>Description of the&nbsp;project</h2>
<p>The project is very simple, you can just add a url and it will retrieve its content asynchronously and
report its length. For the models, it just has a <tt class="docutils literal">Task</tt> model which is used to provide information about
what we want to the asynchronous task to do and retrieve the&nbsp;result:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Task</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">url_length</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>It also has a home view that can be used to start new asynchronous tasks by creating a <tt class="docutils literal">Task</tt> object
with the url we got and passing it to the asynchronous&nbsp;task:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="kn">import</span> <span class="n">FormView</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="n">TaskForm</span>
<span class="kn">from</span> <span class="nn">.tasks</span> <span class="kn">import</span> <span class="n">get_url_length</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Task</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span>

<span class="k">class</span> <span class="nc">TasksHomeFormView</span><span class="p">(</span><span class="n">FormView</span><span class="p">):</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">TaskForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;tasks_home.html&#39;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
        <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_on&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>
</pre></div>
<p>And finally the asynchronous job itself that retrieves the task from the database,
requests its url and saves its&nbsp;length:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span> <span class="nn">rq</span> <span class="kn">import</span> <span class="n">get_current_job</span>
<span class="kn">from</span> <span class="nn">django_rq</span> <span class="kn">import</span> <span class="n">job</span>

<span class="nd">@job</span>
<span class="k">def</span> <span class="nf">get_url_length</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">jb</span> <span class="o">=</span> <span class="n">get_current_job</span><span class="p">()</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">task_id</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">url_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">jb</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
    <span class="n">task</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
    <span class="n">task</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>The above should be fairly obvious: The user visits the homepage and enters a url at the input. When he presses submit
the view will create a new <tt class="docutils literal">Task</tt> object with the url that the user entered and fire-off the <tt class="docutils literal">get_url_length</tt> asynchronous job passing the
task id of the task that was just created. It will then return immediately without waiting for the asynchronous job to complete. The user will
need to refresh to see the result of his job; this is the usual behavior with async&nbsp;jobs.</p>
<p>The asynchronous job on the other hand will retrieve the task whose id got as a parameter from the database, do the work it needs to do
and update the result when it is&nbsp;finished.</p>
<p>Unfortunately, the above simple setup will <em>probably</em> behave erratically by randomly throwing database related&nbsp;errors!</p>
</div>
<div class="section" id="cause-of-the-problem">
<h2>Cause of the&nbsp;problem</h2>
<p>In the previous section I said <em>probably</em> because the erratic behavior is caused by a specific setting of your Django project; the <tt class="docutils literal">ATOMIC_REQUESTS</tt>.
This setting can be set on your database connection and if it is <tt class="docutils literal"><span class="caps">TRUE</span></tt> then each request will be <em>atomic</em>. This means that each request will be tied with
a database transaction i.e a transaction will be started when your request starts and commited only when your requests finishes; if for some reason your
request throws an error then the transaction will be rolled back. An example of this setting&nbsp;is:</p>
<div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;db.sqlite3&#39;</span><span class="p">),</span>
        <span class="s1">&#39;ATOMIC_REQUESTS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Now, in my opinion, <tt class="docutils literal">ATOMIC_REQUESTS</tt> is a great thing to have because it makes everything much easier. I always set it to <tt class="docutils literal">True</tt> to my projects because
I don&#8217;t need to actually think about transactions and requests; I know that if there&#8217;s a problem in a request the whole transaction will be rolle back and no
garbage will be left in the database. If on the other hand for some reason a request does not need to be tied to a transaction I just set it off
for this specific transaction (using <cite>transaction.non_atomic_requests_</cite>). Please notice that by default the <tt class="docutils literal">ATOMIC_REQUESTS</tt> has a <tt class="docutils literal">False</tt> value which means that
the database will be in autocommit mode meaning that every command will be executed&nbsp;immediately.</p>
<p>So although the <tt class="docutils literal">ATOMIC_REQUESTS</tt> is great, it is actually the reason that there are problems with asynchronous tasks. Why? Let&#8217;s take a closer look at what the <tt class="docutils literal">form_valid</tt> of the view&nbsp;does:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span> <span class="c1">#1</span>
    <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="c1">#2</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span> <span class="c1">#3</span>
</pre></div>
<p>It creates the task in #1, fires off the asynchronous task in #2 and continues the execution of the view processing in #3. The important thing to understand
here is that the transaction will be commited <em>only after #3</em> is finished. This means that there&#8217;s a possibility that the asynchronous task will be started
before #3 is finished thus it won&#8217;t find the task because the task will <em>not</em> be created yet(!) This is a little counter-intuitive but you must remember
that the async task is run by a worker which is a different process than your application server; the worker may be able to start before the transaction is&nbsp;commited.</p>
<p>If you want to actually see the problem <em>every time</em> you can add a small delay between the start of the async task and the <tt class="docutils literal">form_valid</tt> something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>This will make the view more slow so the asynchronous worker will always have time to start executing the task (and get the not found error). Also notice
that if you had <tt class="docutils literal">ATOMIC_REQUESTS: False</tt> the above code would work fine because the task would be created immediately (auto-commited) and the async job would be able to find&nbsp;it.</p>
</div>
<div class="section" id="the-solution">
<h2>The&nbsp;solution</h2>
<p>So how is this problem solved? Well it&#8217;s not that difficult now that you know what&#8217;s causing&nbsp;it!</p>
<p>One solution would be to set <tt class="docutils literal">ATOMIC_REQUESTS</tt> to <tt class="docutils literal">False</tt> but that would make all database commands auto-commit so you&#8217;ll lose
request-transaction-tieing. Another solution would be to set <tt class="docutils literal">ATOMIC_REQUESTS</tt> to <tt class="docutils literal">True</tt> and disable atomic requests for the specific view that starts the
asynchronous job using <cite>transaction.non_atomic_requests_</cite>. This is a viable solution however I don&#8217;t like it because I&#8217;d lose the comfort of transaction per request
for this specific request and I would need to add my own transaction&nbsp;handling.</p>
<p>A third solution is to avoid messing with the database in your view and create the task object in the async job. Any parameters you want to pass to the async job would be
passed directly to the async function. This may work fine in some cases but I find it more safe to create the task in the database before starting the async job so that
I have better control and error handling. This way even if there&#8217;s an error in my worker and for some reason the async job never starts or it breaks before being able to
handle the database, I will have the task object in the database because it will have been created in the&nbsp;view.</p>
<p>Is there anything better? Isn&#8217;t there a way to start the executing the async job <em>after</em> the transaction of the
view is commited? Actually yes, there is! For this, <a class="reference external" href="https://docs.djangoproject.com/en/2.1/topics/db/transactions/#django.db.transaction.on_commit">transaction.on_commit</a> comes to the rescue! This function
receives a callback that will be called after the transaction is commited! Thus, to properly fix you project, you should
change the <tt class="docutils literal">form_valid</tt> method like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">on_commit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>Notice that I need to use <tt class="docutils literal">lambda</tt> to create a callback function that will call <tt class="docutils literal">get_url_length.delay(task.id)</tt> when the transaction is commited. Now
even though I have the delay there the async job will start after the transaction is commited, ie after the view handler is finished (after the 1 second&nbsp;delay).</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>From the above you should be able to understand why sometimes you have problems when your async jobs use the database. To fix it you have various
options but at least for me, the best solution is to start your async jobs <em>after</em> the transaction is commited using <tt class="docutils literal">transaction.on_commit</tt>. Just
change each <tt class="docutils literal">async.job.delay(parameters)</tt> call to <tt class="docutils literal">transaction.on_commit(lambda: async.job.delay(parameters))</tt> and you will be&nbsp;fine!</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://spapas.github.io/2018/11/12/du-disk-usage/">Use du to find out the disk usage of each directory in unix</a>
      </h1>
    <p class="meta">
<time datetime="2018-11-12T14:20:00+02:00" pubdate>Δευ 12 Νοέμβριος 2018</time>    </p>
</header>

<div class="entry-content"><p>One usual problem I have when dealing with production servers is that their
disks get filled.  This results in various warnings and errors and should be fixed
immediately. The first step to resolve this issue is to actually find out where is that
hard disk space is&nbsp;used!</p>
<p>For this you can use the <cite>du</cite> unix tool with some parameters. The problem is that <cite>du</cite>
has various parameters (not needed for the task at hand) and the various
places I search for contain other info not related to this specific&nbsp;task.</p>
<p>Thus I&#8217;ve decided to write this small blog post to help people struggling with
this and also to help <em>me</em> avoid googling for it by searching in pages that
also contain other <tt class="docutils literal">du</tt> recipies and also avoid the trial and error that this
would&nbsp;require.</p>
<p>So to print out the disk usage summary for a directory go to that directory
and run <tt class="docutils literal">du <span class="pre">-h</span> <span class="pre">-s</span> *</tt>; you need to have access to the child subdirectories
so probably it&#8217;s better to try this as root (unless you go to your home dir
for&nbsp;example).</p>
<p>Here&#8217;s a sample&nbsp;usage:</p>
<pre class="code literal-block">
[root&#64;server1 /]# cd /
[root&#64;server1 /]# du -h -s *
7.2M    bin
55M     boot
164K    dev
35M     etc
41G     home
236M    lib
25M     lib64
20K     lost+found
8.0K    media
155G    mnt
0       proc
1.6G    root
12M     sbin
8.0K    srv
427M    tmp
3.2G    usr
8.9G    var
</pre>
<p>The parameters are -h to print human readable sizes (G, M etc) and -s to
print a summary usage of <em>each</em> parameter. Since this will output the
summary for each parameter I finally pass <tt class="docutils literal">*</tt> to be changed to all files/dirs
in that directory. If I used <tt class="docutils literal">du <span class="pre">-h</span> <span class="pre">-s</span> /tmp</tt> instead I&#8217;d get the total usage only for
the <tt class="docutils literal">/tmp</tt> directory.</p>
<p>Another trick that may help you quickly find out the offending directories is to
append the <tt class="docutils literal">| grep G</tt> pipe command (i.e run <tt class="docutils literal">du <span class="pre">-h</span> <span class="pre">-s</span> * | grep G</tt>) which will
filter out only the entries containing a <tt class="docutils literal">G</tt> (i.e only print the folders having
more than 1 <span class="caps">GB</span> size). Yeh I know that this will also print entries that have
also a G in their name but since there aren&#8217;t many directores that have
G in their name you should be&nbsp;ok.</p>
<p>If you run the above from <tt class="docutils literal">/</tt> so that <tt class="docutils literal">/proc</tt> is included you may
get a bunch of <tt class="docutils literal">du: cannot access 'proc/nnn/task/nnn/fd/4': No such file or directory</tt>
errors; just add the <tt class="docutils literal">2&gt; /dev/null</tt> pipe redirect to redirect the stderr output
to <tt class="docutils literal">/dev/null</tt>, i.e run <tt class="docutils literal">du <span class="pre">-h</span> <span class="pre">-s</span> * 2&gt; /dev/null</tt>.</p>
<p>Finally, please notice that if there are <em>lots</em> of files in your directory you&#8217;ll get
a lot of output entries (since the <cite>*</cite> will match both files and directories).
In this case you can use <tt class="docutils literal">echo */</tt> or <tt class="docutils literal">ls <span class="pre">-d</span> */</tt> to list only the directories;
append that command inside a ` pair or <tt class="docutils literal">$()</tt> (to substitute for the command
output) instead of the <tt class="docutils literal">*</tt> to only get the sizes of the
directories, i.e run <tt class="docutils literal">du <span class="pre">-h</span> <span class="pre">-s</span> $(echo */)</tt> or <tt class="docutils literal">du <span class="pre">-h</span> <span class="pre">-s</span> `echo */`</tt>.</p>
<p>One thing that you must be aware of is that this command may take <em>a long time</em>
especially if you have lots of small files somewhere. Just let it run and it
should finish after some time. If it takes too long time try to exclude any
mounted network
directories (either with <span class="caps">SMB</span> or <span class="caps">NFS</span>) since these will take extra long&nbsp;time.</p>
<p>Also, if you awant a nice interactive output
using ncurses you can download and compile the <a class="reference external" href="https://dev.yorhel.nl/ncdu">ncdu tool</a> (NCurses Disk&nbsp;Usage).</p>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://spapas.github.io/2018/05/08/django-reponse-add-delay/">Adding a delay to Django HTTP responses</a>
      </h1>
    <p class="meta">
<time datetime="2018-05-08T23:20:00+03:00" pubdate>Τρι 08 Μάιος 2018</time>    </p>
</header>

<div class="entry-content"><p>Sometimes you&#8217;d like to make your Django views more slow by adding a fake delay. This may
sound controversial (why would somebody want to make some of his views slower) however it is a real requirement,
at least when developing an&nbsp;application.</p>
<p>For example, you may be using a <span class="caps">REST</span> <span class="caps">API</span> and you want to implement a spinner while your form is loading. However, usually when
developing your responses will load so soon that you won&#8217;t be able to admire your spinner in all its glory! Also, when you
submit a <span class="caps">POST</span> form (i.e a form that changes your data), it is advisable to disable your submit button so that when your users
double click it the form won&#8217;t be submitted two times (it may seem strange to some people but this is a very common error that
has bitten me many times; there are many users that think that they need to double click the buttons; thus I always disable
my submit buttons after somebody clicks them); in this case you also need to make your response a little slower to make sure
that the button is actually&nbsp;disabled!</p>
<p>I will propose two methods for adding this delay to your responses. One that will affect all (or most) your views using
a <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/">middleware</a> and another that you can add to any <span class="caps">CBV</span> you want using a mixin; please see my previous <a class="reference external" href="https://spapas.github.io/2018/03/19/comprehensive-django-cbv-guide/"><span class="caps">CBV</span> guide</a> for more on
Django CBVs and mixins. For the middleware solution we&#8217;ll also take a quick look at what is the Django middleware mechanism and
how it can be used to add&nbsp;functionality.</p>
<div class="section" id="using-middleware">
<h2>Using&nbsp;middleware</h2>
<p>The Django <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/">middleware</a> is a mechanism for adding your own code to the Django request / response cycle. I&#8217;ll try to explain
this a bit; Django is waiting for an <span class="caps">HTTP</span> Request (i.e <span class="caps">GET</span> a url with these headers and these query parameters), it will
parse this <span class="caps">HTTP</span> Request and prepare an <span class="caps">HTTP</span> Response (i.e some headers and a Payload). Your view will be the main actor for
retrieving the <span class="caps">HTTP</span> response and returning the <span class="caps">HTTP</span> request. However, using this middleware mechanism Django allows you to
enable other actors (the middleware) that will universally modify the <span class="caps">HTTP</span> request before passing it to your view and will also
modify the view&#8217;s <span class="caps">HTTP</span> respone before sending it back to the&nbsp;client.</p>
<p>Actually, a list of middleware called &#8230; <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> is <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/#activating-middleware">defined by default</a> in the <tt class="docutils literal">settings.py</tt> of all new Django
projects; these are used to add various capabilities
that are universally needed, for example session support, various security enablers, django message support and others. You
can easily attach your own middleware to that list to add extra functionality. Notice that the order of the middleware in the <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt>
list actually matters. Middleware later in the list will be executed after the ones previous in the list; we&#8217;ll see some consequences of this&nbsp;later.</p>
<p>Now the time has come to take a quick look at how to implement a middleware, <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/#writing-your-own-middleware">taken from the Django docs</a>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleMiddleware</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>
        <span class="c1"># One-time configuration and initialization.</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Code to be executed for each request before</span>
        <span class="c1"># the view (and later middleware) are called.</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Code to be executed for each request/response after</span>
        <span class="c1"># the view is called.</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>Actually you can implement the middleware as a nested function however I prefer the classy version. The comments should be really enlightening:
When your project is started the constructor (<tt class="docutils literal">__init__</tt>) will be called once, for example if you want to read a configuration setting from the database
then you should do it in the <tt class="docutils literal">__init__</tt> to avoid calling the database everytime your middleware is executed (i.e for <em>every</em> request). The <tt class="docutils literal">__call__</tt> is
a special method that gets translated to calling this class instance as a function, i.e if you do something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="n">sm</span> <span class="o">=</span> <span class="n">SimpleMiddleware</span><span class="p">()</span>
<span class="n">sm</span><span class="p">()</span>
</pre></div>
<p>Then <tt class="docutils literal">sm()</tt> will execute the <tt class="docutils literal">__call__</tt>; there are various similar <a class="reference external" href="http://www.diveintopython3.net/special-method-names.html">python special methods</a>, for example <tt class="docutils literal">__len__</tt>, <tt class="docutils literal">__eq__</tt> etc</p>
<p>Now, as you can see the <tt class="docutils literal">__call__</tt> special method has four&nbsp;parts:</p>
<ul class="simple">
<li>Code that is executed <em>before</em> the <tt class="docutils literal">self.get_response()</tt> method is called; here you should modify the request object. Middleware will reach this point in the order they are&nbsp;listed.</li>
<li>The actual call to <tt class="docutils literal">self.get_response()</tt></li>
<li>Code that is executed <em>after</em> the <tt class="docutils literal">self.get_response()</tt> method is called; here you should modify the response object. Middleware will reach this point in the reverse order they are&nbsp;listed.</li>
<li>Returning the response to be used by the next&nbsp;middleware</li>
</ul>
<p>Notice that <tt class="docutils literal">get_response</tt> will call the next middleware; while the <tt class="docutils literal">get_response</tt> for the last middleware will actually call the view. Then
the view will return a response which could be modified (if needed) by the middlewares in the opposite order of their definition&nbsp;list.</p>
<p>As an example, let&#8217;s define two simple&nbsp;middlewares:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">M1</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M1 before response&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M1 after response&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

<span class="k">class</span> <span class="nc">M2</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M2 before response&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M2 after response&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>When you define <tt class="docutils literal"><span class="caps">MIDDLEWARE</span> = ['M1', 'M2']</tt> you&#8217;ll see the&nbsp;following:</p>
<div class="highlight"><pre><span></span><span class="c1"># Got the request</span>
<span class="n">M1</span> <span class="n">before</span> <span class="n">response</span>
<span class="n">M2</span> <span class="n">before</span> <span class="n">response</span>
<span class="c1"># The view is rendered to the response now</span>
<span class="n">M2</span> <span class="n">after</span> <span class="n">response</span>
<span class="n">M1</span> <span class="n">after</span> <span class="n">response</span>
<span class="c1"># Return the response</span>
</pre></div>
<p>Please notice a middleware may not call <tt class="docutils literal">self.get_response</tt> to continue the chain but return directly a response (for example a 403 Forbiden&nbsp;response).</p>
<p>After this quick introduction to how middleware works, let&#8217;s take a look at a skeleton for the time-delay&nbsp;middleware:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">TimeDelayMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>This is really simple, I&#8217;ve just added an extra line to the previous middleware. This line adds a one-second delay to all responses. I&#8217;ve
added it before <tt class="docutils literal">self.get_response</tt> - because this delay does not depend on anything, I could have added it after <tt class="docutils literal">self.get_response</tt>
without changes in the behavior. Also, the order of this middleware in the <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> list doesn&#8217;t matter since it doesn&#8217;t depend on
other middleware (it just needs to run to add the&nbsp;delay).</p>
<p>This middleware may have a little more functionality, for example to configure the delay from the settings or add the delay only for
specific urls (by checking the <tt class="docutils literal">request.path</tt>).
Here&#8217;s how these extra features could be&nbsp;implemented:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>

<span class="k">class</span> <span class="nc">TimeDelayMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">REQUEST_TIME_DELAY</span>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;/api/&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The above will add the delay only to requests whose path contains <tt class="docutils literal">'/api'</tt>. Another case is if you want to
only add the delay for <tt class="docutils literal"><span class="caps">POST</span></tt> requests by checking that <tt class="docutils literal">request.method == '<span class="caps">POST</span>'</tt>.</p>
<p>Now, to install this middleware, you can configure your <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> like this in your <tt class="docutils literal">settings.py</tt>
(let&#8217;s say that you have an application named <tt class="docutils literal">core</tt> containing a module named <tt class="docutils literal">middleware</tt>):</p>
<div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>

    <span class="s1">&#39;core.middleware.TimeDelayMiddleware&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
<p>The other middleware are the default ones in Django. One more thing to consider is that if
you have a single settings.py this middleware will be called; one way to override the delay
is to check for settings.<span class="caps">DEBUG</span> and only call <tt class="docutils literal">time.sleep</tt> when <tt class="docutils literal"><span class="caps">DEBUG</span> == True</tt>. However,
the proper way to do it is to have different settings for your development and production
environments and add the <tt class="docutils literal">TimeDelayMiddleware</tt> only to your development <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> list.
Having different settings for each development is a <a class="reference external" href="https://medium.com/&#64;ayarshabeer/django-best-practice-settings-file-for-multiple-environments-6d71c6966ee2">common practice in Django</a> and I totally
recommend to use&nbsp;it.</p>
</div>
<div class="section" id="using-cbvs">
<h2>Using&nbsp;CBVs</h2>
<p>Another method to add a delay to the execution of a view is to implement a TimeDelayMixin and inherit
your Class Based View from it. As we&#8217;ve seen in the <a class="reference external" href="https://spapas.github.io/2018/03/19/comprehensive-django-cbv-guide/"><span class="caps">CBV</span> guide</a>, the <tt class="docutils literal">dispatch</tt> method is the one
that is always called when your <span class="caps">CBV</span> is rendered, thus your <tt class="docutils literal">TimeDelayMixin</tt> could be implemented like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">TimeDelayMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">):</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>This is very simple (and you can use similar techniques as described for the middleware above to configure
the delay time or add the delay only when <tt class="docutils literal">settings.<span class="caps">DEBUG</span> == True</tt> etc) - to actually use it, just inherit your
view from this mixin,&nbsp;f.e:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DelayedSampleListView</span><span class="p">(</span><span class="n">TimeDelayMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sample</span>
</pre></div>
<p>Now whenever you call your <tt class="docutils literal">DelayedSampleListView</tt> you&#8217;ll see it after the configured&nbsp;delay!</p>
<p>What is really interesting is that the <tt class="docutils literal">dispatch</tt> method actually exists (and has the same functionality) also
in Django Rest Framework CBVs, thus using the same mixin you can add the delay not only your normal CBVs but
also your <span class="caps">DRF</span> <span class="caps">API</span>&nbsp;views!</p>
</div>
</div>
  		</article>
<div class="pagination">
    <a class="prev" href="https://spapas.github.io/index3.html">&larr; Older</a>

    <a class="next" href="https://spapas.github.io/index.html">Newer &rarr;</a>
  <br />
</div></div>
<aside class="sidebar">
  <section>
    <br />
    <a href='/feeds/all.atom.xml'>Atom</a>
    |
    <a href='/feeds/all.rss.xml'>RSS</a>
  </section>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Sidebar unit -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7673322832689008" data-ad-slot="2720624730"
    data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>

  <section>
    <h1>Subscribe</h1>
    Do you want to get notified via email when I post new content?
    <style>
      .subscribe-button {
        /* margin: 10px !important; */
        padding: 10px !important;
        background-color: black;
        display: inline-block;
        color: white !important;
        text-decoration: none;

        line-height: 36px !important;
        height: 37px !important;
        text-decoration: none !important;
        display: inline-block !important;
        color: #ffffff !important;
        background-color: #000000 !important;
        border-radius: 3px !important;
        border: 1px solid transparent !important;
        padding: 1px 9px !important;
        font-size: 23px !important;
        letter-spacing: 0.6px !important;
        box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;
        -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
        margin: 0 auto !important;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
        -o-transition: 0.3s all linear !important;
        -webkit-transition: 0.3s all linear !important;
        -moz-transition: 0.3s all linear !important;
        -ms-transition: 0.3s all linear !important;
        transition: 0.3s all linear !important;

      }
    </style>
    <a class='subscribe-button' target="_blank" href="http://eepurl.com/dxI3PP">Click here to subscribe!</a>
  </section>

  <style>
    .bmc-button img {
      width: 27px !important;
      margin-bottom: 3px !important;
      box-shadow: none !important;
      border: none !important;
      vertical-align: middle !important;
    }

    .bmc-button {
      line-height: 36px !important;
      height: 37px !important;
      text-decoration: none !important;
      display: inline-block !important;
      color: #ffffff !important;
      background-color: #000000 !important;
      border-radius: 3px !important;
      border: 1px solid transparent !important;
      padding: 1px 9px !important;
      font-size: 23px !important;
      letter-spacing: 0.6px !important;
      ;
      box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;
      -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
      margin: 0 auto !important;
      font-family: 'Cookie', cursive !important;
      -webkit-box-sizing: border-box !important;
      box-sizing: border-box !important;
      -o-transition: 0.3s all linear !important;
      -webkit-transition: 0.3s all linear !important;
      -moz-transition: 0.3s all linear !important;
      -ms-transition: 0.3s all linear !important;
      transition: 0.3s all linear !important;
    }

    .bmc-button:hover,
    .bmc-button:active,
    .bmc-button:focus {
      -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
      text-decoration: none !important;
      box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
      opacity: 0.85 !important;
      color: #ffffff !important;
    }
  </style>
  <link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet">


  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
        <a href="https://spapas.github.io/2020/03/27/wagtail-add-latest-changes/">Adding a latest-changes list to your Wagtail site</a>
      </li>
      <li class="post">
        <a href="https://spapas.github.io/2020/03/18/django-crispy-form-quick-easy-layout/">Quick and easy layout of django forms using django-crispy-forms and django-widget-tweaks</a>
      </li>
      <li class="post">
        <a href="https://spapas.github.io/2019/10/17/declarative-ecto-query-sorting/">Declarative Ecto query sorting</a>
      </li>
      <li class="post">
        <a href="https://spapas.github.io/2019/10/03/html-form-submit-php/">How to properly handle an HTML form</a>
      </li>
      <li class="post">
        <a href="https://spapas.github.io/2019/07/25/declarative-ecto-query-filters/">Declarative Ecto query filters</a>
      </li>
    </ul>
  </section>
  <section>

    <h1>Categories</h1>
    <ul id="recent_posts">
      <li><a href="https://spapas.github.io/category/android.html">android</a></li>
      <li><a href="https://spapas.github.io/category/css.html">css</a></li>
      <li><a href="https://spapas.github.io/category/django.html">django</a></li>
      <li><a href="https://spapas.github.io/category/elixir.html">elixir</a></li>
      <li><a href="https://spapas.github.io/category/flask.html">flask</a></li>
      <li><a href="https://spapas.github.io/category/git.html">git</a></li>
      <li><a href="https://spapas.github.io/category/html.html">html</a></li>
      <li><a href="https://spapas.github.io/category/javascript.html">javascript</a></li>
      <li><a href="https://spapas.github.io/category/pelican.html">pelican</a></li>
      <li><a href="https://spapas.github.io/category/postgresql.html">postgresql</a></li>
      <li><a href="https://spapas.github.io/category/python.html">python</a></li>
      <li><a href="https://spapas.github.io/category/spring.html">spring</a></li>
      <li><a href="https://spapas.github.io/category/unix.html">unix</a></li>
      <li><a href="https://spapas.github.io/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>

  <section>
    <h1>Tags</h1>
    <a href="https://spapas.github.io/tag/less.html">less</a>,    <a href="https://spapas.github.io/tag/django-crispy-forms.html">django-crispy-forms</a>,    <a href="https://spapas.github.io/tag/rest.html">rest</a>,    <a href="https://spapas.github.io/tag/query.html">query</a>,    <a href="https://spapas.github.io/tag/ecto.html">ecto</a>,    <a href="https://spapas.github.io/tag/tables.html">tables</a>,    <a href="https://spapas.github.io/tag/pivot_table.html">pivot_table</a>,    <a href="https://spapas.github.io/tag/console.html">console</a>,    <a href="https://spapas.github.io/tag/async.html">async</a>,    <a href="https://spapas.github.io/tag/django-rq.html">django-rq</a>,    <a href="https://spapas.github.io/tag/github-pages.html">github-pages</a>,    <a href="https://spapas.github.io/tag/forms.html">forms</a>,    <a href="https://spapas.github.io/tag/yaml.html">yaml</a>,    <a href="https://spapas.github.io/tag/404.html">404</a>,    <a href="https://spapas.github.io/tag/ldap.html">ldap</a>,    <a href="https://spapas.github.io/tag/immutable.html">immutable</a>,    <a href="https://spapas.github.io/tag/initd.html">init.d</a>,    <a href="https://spapas.github.io/tag/django-widget-tweaks.html">django-widget-tweaks</a>,    <a href="https://spapas.github.io/tag/youtube-dl.html">youtube-dl</a>,    <a href="https://spapas.github.io/tag/python.html">python</a>,    <a href="https://spapas.github.io/tag/django-extensions.html">django-extensions</a>,    <a href="https://spapas.github.io/tag/class-based-views.html">class-based-views</a>,    <a href="https://spapas.github.io/tag/scipy.html">scipy</a>,    <a href="https://spapas.github.io/tag/grid.html">grid</a>,    <a href="https://spapas.github.io/tag/ag-grid.html">ag-grid</a>,    <a href="https://spapas.github.io/tag/du.html">du</a>,    <a href="https://spapas.github.io/tag/watchify.html">watchify</a>,    <a href="https://spapas.github.io/tag/settings.html">settings</a>,    <a href="https://spapas.github.io/tag/flux.html">flux</a>,    <a href="https://spapas.github.io/tag/fixeddatatable.html">FixedDataTable</a>,    <a href="https://spapas.github.io/tag/queries.html">queries</a>,    <a href="https://spapas.github.io/tag/debug.html">debug</a>,    <a href="https://spapas.github.io/tag/imgur.html">imgur</a>,    <a href="https://spapas.github.io/tag/security.html">security</a>,    <a href="https://spapas.github.io/tag/npm.html">npm</a>,    <a href="https://spapas.github.io/tag/hyperapp.html">hyperapp</a>,    <a href="https://spapas.github.io/tag/spring.html">spring</a>,    <a href="https://spapas.github.io/tag/react-redux.html">react-redux</a>,    <a href="https://spapas.github.io/tag/cron.html">cron</a>,    <a href="https://spapas.github.io/tag/babelify.html">babelify</a>,    <a href="https://spapas.github.io/tag/design.html">design</a>,    <a href="https://spapas.github.io/tag/tutorial.html">tutorial</a>,    <a href="https://spapas.github.io/tag/gmail.html">gmail</a>,    <a href="https://spapas.github.io/tag/reportlab.html">reportlab</a>,    <a href="https://spapas.github.io/tag/rq.html">rq</a>,    <a href="https://spapas.github.io/tag/redis.html">redis</a>,    <a href="https://spapas.github.io/tag/python-3.html">python-3</a>,    <a href="https://spapas.github.io/tag/research.html">research</a>,    <a href="https://spapas.github.io/tag/werkzeug.html">werkzeug</a>,    <a href="https://spapas.github.io/tag/jobs.html">jobs</a>,    <a href="https://spapas.github.io/tag/redux-thunk.html">redux-thunk</a>,    <a href="https://spapas.github.io/tag/disk-usage.html">disk-usage</a>,    <a href="https://spapas.github.io/tag/javascript.html">javascript</a>,    <a href="https://spapas.github.io/tag/component.html">component</a>,    <a href="https://spapas.github.io/tag/ajax.html">ajax</a>,    <a href="https://spapas.github.io/tag/elixir.html">elixir</a>,    <a href="https://spapas.github.io/tag/ipython.html">ipython</a>,    <a href="https://spapas.github.io/tag/uglify.html">uglify</a>,    <a href="https://spapas.github.io/tag/configuration.html">configuration</a>,    <a href="https://spapas.github.io/tag/properties.html">properties</a>,    <a href="https://spapas.github.io/tag/bash.html">bash</a>,    <a href="https://spapas.github.io/tag/es6.html">es6</a>,    <a href="https://spapas.github.io/tag/spring-boot.html">spring-boot</a>,    <a href="https://spapas.github.io/tag/postgresql.html">postgresql</a>,    <a href="https://spapas.github.io/tag/kotlin.html">kotlin</a>,    <a href="https://spapas.github.io/tag/adapter.html">adapter</a>,    <a href="https://spapas.github.io/tag/filter.html">filter</a>,    <a href="https://spapas.github.io/tag/flask.html">flask</a>,    <a href="https://spapas.github.io/tag/notebook.html">notebook</a>,    <a href="https://spapas.github.io/tag/static-html.html">static-html</a>,    <a href="https://spapas.github.io/tag/pdf.html">pdf</a>,    <a href="https://spapas.github.io/tag/react-notification.html">react-notification</a>,    <a href="https://spapas.github.io/tag/pelican.html">pelican</a>,    <a href="https://spapas.github.io/tag/tasks.html">tasks</a>,    <a href="https://spapas.github.io/tag/nodejs.html">node.js</a>,    <a href="https://spapas.github.io/tag/unix.html">unix</a>,    <a href="https://spapas.github.io/tag/google.html">google</a>,    <a href="https://spapas.github.io/tag/linux.html">linux</a>,    <a href="https://spapas.github.io/tag/pivot.html">pivot</a>,    <a href="https://spapas.github.io/tag/auditing.html">auditing</a>,    <a href="https://spapas.github.io/tag/git.html">git</a>,    <a href="https://spapas.github.io/tag/java.html">java</a>,    <a href="https://spapas.github.io/tag/introduction.html">introduction</a>,    <a href="https://spapas.github.io/tag/pusher.html">pusher</a>,    <a href="https://spapas.github.io/tag/fixed-data-tables.html">fixed-data-tables</a>,    <a href="https://spapas.github.io/tag/heroku.html">heroku</a>,    <a href="https://spapas.github.io/tag/xhtml2pdf.html">xhtml2pdf</a>,    <a href="https://spapas.github.io/tag/numpy.html">numpy</a>,    <a href="https://spapas.github.io/tag/form.html">form</a>,    <a href="https://spapas.github.io/tag/django-rest-auth.html">django-rest-auth</a>,    <a href="https://spapas.github.io/tag/wagtail.html">wagtail</a>,    <a href="https://spapas.github.io/tag/rst.html">rst</a>,    <a href="https://spapas.github.io/tag/python-2.html">python-2</a>,    <a href="https://spapas.github.io/tag/ffmpeg.html">ffmpeg</a>,    <a href="https://spapas.github.io/tag/middleware.html">middleware</a>,    <a href="https://spapas.github.io/tag/profiles.html">profiles</a>,    <a href="https://spapas.github.io/tag/spring-security.html">spring-security</a>,    <a href="https://spapas.github.io/tag/githubio.html">github.io</a>,    <a href="https://spapas.github.io/tag/error.html">error</a>,    <a href="https://spapas.github.io/tag/asynchronous.html">asynchronous</a>,    <a href="https://spapas.github.io/tag/react-router-redux.html">react-router-redux</a>,    <a href="https://spapas.github.io/tag/select2.html">select2</a>,    <a href="https://spapas.github.io/tag/history.html">history</a>,    <a href="https://spapas.github.io/tag/django-rest-framework.html">django-rest-framework</a>,    <a href="https://spapas.github.io/tag/redux-form.html">redux-form</a>,    <a href="https://spapas.github.io/tag/cbv.html">cbv</a>,    <a href="https://spapas.github.io/tag/scheduling.html">scheduling</a>,    <a href="https://spapas.github.io/tag/plpgsql.html">plpgsql</a>,    <a href="https://spapas.github.io/tag/boilerplate.html">boilerplate</a>,    <a href="https://spapas.github.io/tag/generic.html">generic</a>,    <a href="https://spapas.github.io/tag/babel.html">babel</a>,    <a href="https://spapas.github.io/tag/authentication.html">authentication</a>,    <a href="https://spapas.github.io/tag/html.html">html</a>,    <a href="https://spapas.github.io/tag/android.html">android</a>,    <a href="https://spapas.github.io/tag/pandas.html">pandas</a>,    <a href="https://spapas.github.io/tag/css.html">css</a>,    <a href="https://spapas.github.io/tag/node.html">node</a>,    <a href="https://spapas.github.io/tag/phoenix.html">phoenix</a>,    <a href="https://spapas.github.io/tag/deploy.html">deploy</a>,    <a href="https://spapas.github.io/tag/mongodb.html">mongodb</a>,    <a href="https://spapas.github.io/tag/react.html">react</a>,    <a href="https://spapas.github.io/tag/autocompelte.html">autocompelte</a>,    <a href="https://spapas.github.io/tag/declarative.html">declarative</a>,    <a href="https://spapas.github.io/tag/php.html">php</a>,    <a href="https://spapas.github.io/tag/browserify.html">browserify</a>,    <a href="https://spapas.github.io/tag/branching.html">branching</a>,    <a href="https://spapas.github.io/tag/github.html">github</a>,    <a href="https://spapas.github.io/tag/jupyter.html">jupyter</a>,    <a href="https://spapas.github.io/tag/windows.html">windows</a>,    <a href="https://spapas.github.io/tag/youtube.html">youtube</a>,    <a href="https://spapas.github.io/tag/django.html">django</a>,    <a href="https://spapas.github.io/tag/q.html">q</a>,    <a href="https://spapas.github.io/tag/react-router.html">react-router</a>,    <a href="https://spapas.github.io/tag/redux.html">redux</a>,    <a href="https://spapas.github.io/tag/boostrap-material-design.html">boostrap-material-design</a>  </section>

  <section>
    <h1>Yearly archives</h1>
    <a href="https://spapas.github.io/posts/2013/">2013</a>,    <a href="https://spapas.github.io/posts/2014/">2014</a>,    <a href="https://spapas.github.io/posts/2015/">2015</a>,    <a href="https://spapas.github.io/posts/2016/">2016</a>,    <a href="https://spapas.github.io/posts/2017/">2017</a>,    <a href="https://spapas.github.io/posts/2018/">2018</a>,    <a href="https://spapas.github.io/posts/2019/">2019</a>,    <a href="https://spapas.github.io/posts/2020/">2020</a>  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/spapas">@spapas</a> on GitHub
    <script  src="//code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script type="text/javascript">
      $(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = 'https://spapas.github.io/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'spapas',
              count: 5,
              skip_forks: true,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="https://spapas.github.io/theme/js/github.js" type="text/javascript"> </script>
  </section>


  <section>
    <a href="https://twitter.com/_serafeim_?ref_src=twsrc%5Etfw" class="twitter-follow-button"
      data-show-count="false">Follow @_serafeim_</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013&ndash;2020 Serafeim Papastefanos &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="https://spapas.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="https://spapas.github.io/theme/js/ender.js"></script>
  <script src="https://spapas.github.io/theme/js/octopress.js" type="text/javascript"></script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');

    ga('send', 'pageview');
    </script>
  <script type="text/javascript">
    var disqus_shortname = 'spapas-github-io';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
</body>

</html>